{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="jumbotron bg-light p-5 rounded mb-4">
            <h1 class="display-4">Fermentation Monitor</h1>
            <p class="lead">Webcam-based dough size monitoring using OpenCV</p>
            <hr class="my-4">
            <p>Real-time monitoring of dough size and fermentation progress</p>
            <a class="btn btn-primary btn-lg" href="{{ url_for('dashboard') }}" role="button">View Dashboard</a>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-body text-center">
                <i class="fas fa-camera fa-3x text-success mb-3"></i>
                <h5 class="card-title">Image Analysis</h5>
                <p class="card-text">OpenCV-powered dough size detection and tracking</p>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-body text-center">
                <i class="fas fa-chart-line fa-3x text-primary mb-3"></i>
                <h5 class="card-title">Growth Monitoring</h5>
                <p class="card-text">Track dough size changes over time</p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>Current Status</h5>
            </div>
            <div class="card-body" id="current-status">
                <p>Loading...</p>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>Fermentation Sessions</h5>
            </div>
            <div class="card-body" id="fermentation-sessions">
                <p>Loading...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    updateCurrentStatus();
    updateSessions();
    
    // Update every 30 seconds
    setInterval(updateCurrentStatus, 30000);
    setInterval(updateSessions, 60000);
});

function updateCurrentStatus() {
    fetch('/api/current-status')
        .then(response => response.json())
        .then(data => {
            const statusDiv = document.getElementById('current-status');
            statusDiv.innerHTML = `
                <div class="row">
                    <div class="col-6">
                        <strong>Dough Size:</strong> ${data.dough_size ? data.dough_size.toFixed(1) : 'N/A'}
                    </div>
                    <div class="col-6">
                        <strong>Size Change:</strong> ${data.size_change_percent ? data.size_change_percent.toFixed(1) + '%' : 'N/A'}
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-6">
                        <strong>Camera Status:</strong> ${data.camera_status || 'N/A'}
                    </div>
                    <div class="col-6">
                        <strong>Monitoring:</strong> ${data.monitoring_active ? 'Active' : 'Inactive'}
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-12">
                        <small class="text-muted">Last Updated: ${new Date(data.last_update * 1000).toLocaleString()}</small>
                    </div>
                </div>
            `;
        })
        .catch(error => {
            console.error('Error fetching current status:', error);
        });
}

function updateSessions() {
    fetch('/api/sessions')
        .then(response => response.json())
        .then(data => {
            const sessionsDiv = document.getElementById('fermentation-sessions');
            if (data.length === 0) {
                sessionsDiv.innerHTML = '<p class="text-muted">No active fermentation sessions</p>';
            } else {
                sessionsDiv.innerHTML = data.map(session => `
                    <div class="mb-2">
                        <strong>${session.name}</strong><br>
                        <small class="text-muted">Started: ${new Date(session.start_time * 1000).toLocaleString()}</small>
                    </div>
                `).join('');
            }
        })
        .catch(error => {
            console.error('Error fetching sessions:', error);
        });
}
</script>
{% endblock %}